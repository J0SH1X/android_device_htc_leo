From 9ac05ebcc2ba438c37c4b9489752cf41f78def09 Mon Sep 17 00:00:00 2001
From: maniacx <macs18max@gmail.com>
Date: Sat, 3 Sep 2016 08:35:40 +0800
Subject: [PATCH] Disable blit mode for MDP31

Change-Id: Ib429c70b6c1224f7170739f2c20a9b4ae68f0c22
---
 services/surfaceflinger/Android.mk                     | 4 ++++
 services/surfaceflinger/DisplayHardware/HWComposer.cpp | 2 ++
 services/surfaceflinger/Layer.cpp                      | 1 -
 3 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/services/surfaceflinger/Android.mk b/services/surfaceflinger/Android.mk
index 25fa503..2ded7b3 100644
--- a/services/surfaceflinger/Android.mk
+++ b/services/surfaceflinger/Android.mk
@@ -99,6 +99,10 @@ ifeq ($(BOARD_USE_BGRA_8888),true)
     LOCAL_CFLAGS += -DUSE_BGRA_8888
 endif
 
+ifeq ($(BOARD_USES_MDP31),true)
+    LOCAL_CFLAGS += -DUSES_MDP31
+endif
+
 LOCAL_CFLAGS += -fvisibility=hidden -Werror=format
 LOCAL_CFLAGS += -std=c++11
 
diff --git a/services/surfaceflinger/DisplayHardware/HWComposer.cpp b/services/surfaceflinger/DisplayHardware/HWComposer.cpp
index 17e91d9..678fd1d 100644
--- a/services/surfaceflinger/DisplayHardware/HWComposer.cpp
+++ b/services/surfaceflinger/DisplayHardware/HWComposer.cpp
@@ -738,9 +738,11 @@ status_t HWComposer::prepare() {
                     if (l.compositionType == HWC_OVERLAY) {
                         disp.hasOvComp = true;
                     }
+#ifndef USES_MDP31
                     if (isCompositionTypeBlit(l.compositionType)) {
                         disp.hasFbComp = true;
                     }
+#endif
                     if (l.compositionType == HWC_CURSOR_OVERLAY) {
                         disp.hasOvComp = true;
                     }
diff --git a/services/surfaceflinger/Layer.cpp b/services/surfaceflinger/Layer.cpp
index 6a9cdb7..6437c55 100644
--- a/services/surfaceflinger/Layer.cpp
+++ b/services/surfaceflinger/Layer.cpp
@@ -139,7 +139,6 @@ void Layer::onFirstRef() {
     mSurfaceFlingerConsumer->setName(mName);
 
 #ifdef TARGET_DISABLE_TRIPLE_BUFFERING
-#warning "disabling triple buffering"
     mSurfaceFlingerConsumer->setDefaultMaxBufferCount(2);
 #else
     mSurfaceFlingerConsumer->setDefaultMaxBufferCount(3);
-- 
1.9.1

